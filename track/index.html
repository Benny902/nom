<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>צפייה במשתמש</title>
  <link rel="icon" href="../nomicon.png" type="image/x-icon">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f6f9;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      margin-bottom: 15px;
    }
    form, #otpSection {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    input, select, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #45a049;
    }
    #result {
      margin-top: 25px;
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      width: 300px;
      animation: fadeIn 0.4s ease-in-out;
    }
    #result h3 {
      margin-bottom: 10px;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      margin-top: 8px;
    }
    .status-active {
      background-color: #28a745;
    }
    .status-paused {
      background-color: #dc3545;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<h2>שלום, הכנס מספר פלאפון לצפייה במשתמש שלך</h2>

<form id="trackForm">
  <input type="text" id="phoneInput" placeholder="מספר פלאפון (10 ספרות)" required>
  <select id="branchSelect">
    <option value="ראשון לציון">ראשון לציון</option>
    <option value="הרצליה">הרצליה</option>
    <option value="ראש העין">ראש העין</option>
  </select>
  <button type="submit">חפש</button>
</form>

<div id="otpSection" style="display:none;">
  <input type="text" id="otpInput" placeholder="קוד אימות" required>
  <button id="verifyOtpBtn">אמת קוד</button>
</div>

<div id="result"></div>

<script>
const BACKEND_URL = 'https://nom-gaming-backend.onrender.com'; // live backend
//const BACKEND_URL = 'http://localhost:3000'; // test backend

let trackedClients = [];
let pendingPhone = '';
let pendingBranch = '';

const CACHE_KEY = 'trackedClientsCache';
const CACHE_TTL = 60 * 60 * 1000; // 1 hour in ms

function saveCache(phone, branch, clients) {
  const data = {
    phone,
    branch,
    clients,
    timestamp: Date.now()
  };
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
}

function loadCache() {
  const raw = localStorage.getItem(CACHE_KEY);
  if (!raw) return null;
  try {
    const data = JSON.parse(raw);
    if (Date.now() - data.timestamp > CACHE_TTL) {
      localStorage.removeItem(CACHE_KEY);
      return null;
    }
    return data;
  } catch {
    return null;
  }
}

function formatTime(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function getRemainingSeconds(client) {
  if (client.paused || !client.startTimestamp)
    return Math.max(0, client.totalSeconds - client.elapsedSeconds);

  const start = new Date(client.startTimestamp).getTime();
  const now = Date.now();
  const extraElapsed = Math.floor((now - start) / 1000);
  return Math.max(0, client.totalSeconds - (client.elapsedSeconds + extraElapsed));
}

function renderClients() {
  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = '';

  trackedClients.forEach(client => {
    const remaining = getRemainingSeconds(client);
    const isActive = !client.paused;
    const statusClass = isActive ? 'status-active' : 'status-paused';
    const statusText = isActive ? 'פעיל' : 'לא פעיל';

    const card = document.createElement('div');
    card.style.marginBottom = '15px';
    card.innerHTML = `
      <h3>${client.name}</h3>
      <p id="remaining-${client.id}">יתרת זמן: ${formatTime(remaining)}</p>
      <span class="status-badge ${statusClass}">${statusText}</span>
      <hr>
    `;
    resultDiv.appendChild(card);
  });
}

document.getElementById('trackForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const phone = document.getElementById('phoneInput').value.trim();
  const branch = document.getElementById('branchSelect').value;

  if (!/^[0][0-9]{9}$/.test(phone)) {
    alert('אנא הכנס מספר פלאפון תקין (10 ספרות)');
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/request-otp`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone })
    });
    if (!res.ok) {
      alert('שגיאה בשליחת קוד האימות');
      return;
    }
    pendingPhone = phone;
    pendingBranch = branch;
    document.getElementById('otpSection').style.display = 'flex';
    alert('קוד אימות נשלח לוואטסאפ שלך');
  } catch (err) {
    console.error('OTP request error:', err);
    alert('שגיאה בשליחת קוד האימות');
  }
});

document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
  const code = document.getElementById('otpInput').value.trim();
  if (!code) {
    alert('אנא הכנס קוד אימות');
    return;
  }
  try {
    const res = await fetch(`${BACKEND_URL}/verify-otp`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: pendingPhone, code })
    });
    const data = await res.json();
    if (res.ok && data.verified) {
      fetchClientsList(pendingPhone, pendingBranch, true);
    } else {
      alert(data.message || 'קוד לא נכון');
    }
  } catch (err) {
    console.error('OTP verify error:', err);
    alert('שגיאה באימות הקוד');
  }
});

async function fetchClientsList(phone, branch, saveToCache = false) {
  try {
    const res = await fetch(`${BACKEND_URL}/clients-by-phone?phone=${encodeURIComponent(phone)}&branch=${encodeURIComponent(branch)}`);
    if (!res.ok) {
      alert('לא נמצאו משתמשים עם מספר זה.');
      return;
    }
    trackedClients = await res.json();
    if (saveToCache) saveCache(phone, branch, trackedClients);
    renderClients();
  } catch (err) {
    console.error('Error fetching clients:', err);
    alert('שגיאה בחיפוש המשתמש');
  }
}

setInterval(() => {
  trackedClients.forEach(client => {
    if (!client.paused) {
      const remaining = getRemainingSeconds(client);
      const el = document.getElementById(`remaining-${client.id}`);
      if (el) el.textContent = `יתרת זמן: ${formatTime(remaining)}`;
    }
  });
}, 1000);

// Auto-load from cache if exists
const cached = loadCache();
if (cached) {
  trackedClients = cached.clients;
  pendingPhone = cached.phone;
  pendingBranch = cached.branch;
  renderClients();
}
</script>

</body>
</html>
